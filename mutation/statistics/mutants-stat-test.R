# ------------------------------------------------------------------------------
# This script runs t.test and wilcox.test on the mutation data generated by the
# previously proposed mutation operators vs our proposed mutation operators.
#
# Usage:
# Rscript mutants-stat-test.R
#   <mutation data file path, e.g., ../data/generated/mut-data.csv>
# ------------------------------------------------------------------------------

source('../../utils/statistics/utils.R')
library('dplyr', lib.loc=local_library)

'%!in%' <- function(x,y)!('%in%'(x,y)) # Wrapper to 'not in'

# ------------------------------------------------------------------------- Args

args = commandArgs(trailingOnly=TRUE)
if (length(args) != 1) {
  stop('USAGE: Rscript mutants-stat-test.R <mutation data file path, e.g., ../data/generated/mut-data.csv>')
}

# Args
DATA_FILE_PATH  <- args[1] # benchmark_name,program_name,mutation_position,mutation_operator,mutation,status,parsing_time,plugin_time,resolution_time,verification_time,run_time

# ------------------------------------------------------------------------- Main

# Load data
df <- read.csv(DATA_FILE_PATH, header=TRUE, stringsAsFactors=FALSE)

# Label mutants generated by previously proposed mutation operators vs new proposed mutation operators
df$'type' <- NA
df$'type'[df$'mutation_operator' %in% c('VER', 'FAR', 'MCR', 'DCR', 'MVR', 'SAR', 'TAR', 'CBE', 'SWS', 'SWV')] <- 'new'
df$'type'[df$'mutation_operator' %!in% c('VER', 'FAR', 'MCR', 'DCR', 'MVR', 'SAR', 'TAR', 'CBE', 'SWS', 'SWV')] <- 'old'

head(df)

# Summarize counts per program and type
df_counts <- df %>%
  group_by(program_name, type) %>%
  summarise(
    killed = sum(status == 'killed'),
    not_killed = sum(status != 'killed'),
    total = n(),
    .groups = 'drop'
  )
head(df_counts)

# Compute ratios
df_wide <- df_counts %>%
  mutate(ratio = killed / total) %>%
  select(program_name, type, ratio) %>%
  tidyr::pivot_wider(names_from = type, values_from = ratio,
                     names_prefix = 'ratio_')
# Fix missing rations (e.g., one program that was only mutated by either the old or the new operators)
df_wide$'ratio_old'[is.na(df_wide$'ratio_old')] <- 0
df_wide$'ratio_new'[is.na(df_wide$'ratio_new')] <- 0
df_wide$'diff' <- df_wide$'ratio_old' - df_wide$'ratio_new'
head(df_wide)
print(summary(df_wide))

print(nrow(df_wide[df_wide$'diff' > 0, ]))  # old better
print(nrow(df_wide[df_wide$'diff' < 0, ]))  # new better
print(nrow(df_wide[df_wide$'diff' == 0, ])) # equal

#
# Compute per-program paired test on ratios
#

t <- t.test(df_wide$'ratio_new', df_wide$'ratio_old', paired=TRUE, conf.level=0.99)
print(t)

w <- wilcox.test(df_wide$'ratio_new', df_wide$'ratio_old', paired=TRUE, conf.level=0.99)
print(w)

# EOF

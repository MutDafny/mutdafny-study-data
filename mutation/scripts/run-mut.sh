#!/usr/bin/env bash
#
# ------------------------------------------------------------------------------
# Given a Dafny program (i.e., a .dfy file) and a set of mutation targets, this
# script generated all mutants defined in the set, in a nutshell, it runs MutDafny's
# mut command and writes the generated mutants to the provided output directory.
#
# Usage:
# run-mut.sh
#   --input_file_path <full path to a Dafny program, e.g., $SCRIPT_DIR/../../.third-parties/dafnybench/DafnyBench/dataset/ground_truth/630-dafny_tmp_tmpz2kokaiq_Solution.dfy>
#   --targets_file_path <full path to the targets.csv file generated by the run-scan.sh script, e.g., $SCRIPT_DIR/../data/generated/scan/data/BOR/630-dafny_tmp_tmpz2kokaiq_Solution/targets.csv>
#   --helpers_file_path <full path to the helpers.txt file generated by the run-scan.sh script, e.g., $SCRIPT_DIR/../data/generated/scan/data/BOR/630-dafny_tmp_tmpz2kokaiq_Solution/helpers.txt>
#   --output_file_path <full path to the file where runtime data will be written, e.g., $SCRIPT_DIR/../data/generated/mut/data/<mutation operator>/<Dafny program name>/data.csv>
#   --output_directory_path <full path to the directory where mutants will be saved, e.g., $SCRIPT_DIR/../data/generated/mut/mutants/<mutation operator>/<Dafny program name>/>
#   [help]
# ------------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" > /dev/null 2>&1 && pwd)"
source "$SCRIPT_DIR/../../utils/scripts/utils.sh" || exit 1

# ------------------------------------------------------------------------- Envs

# Check whether the .third-parties' directory is available
THIRD_PARTIES_DIR="$SCRIPT_DIR/../../.third-parties/"
[ -d "$THIRD_PARTIES_DIR" ] || die "[ERROR] $THIRD_PARTIES_DIR does not exist!"

# Check whether the mutdafny's directory is available
MUTDAFNY_HOME_DIR="$THIRD_PARTIES_DIR/mutdafny"
[ -d "$MUTDAFNY_HOME_DIR" ] || die "[ERROR] $MUTDAFNY_HOME_DIR does not exist!"

# Check whether the dotnet's is available
DOTNET_HOME_DIR="$THIRD_PARTIES_DIR/dotnet"
[ -d "$DOTNET_HOME_DIR" ] || die "[ERROR] $DOTNET_HOME_DIR does not exist!"
"$DOTNET_HOME_DIR/dotnet" --version > /dev/null 2>&1 || die "[ERROR] 'dotnet' is not available!"

# ------------------------------------------------------------------------- Args

USAGE="Usage: ${BASH_SOURCE[0]} \
  --input_file_path <full path to a Dafny program, e.g., $SCRIPT_DIR/../../.third-parties/dafnybench/DafnyBench/dataset/ground_truth/630-dafny_tmp_tmpz2kokaiq_Solution.dfy> \
  --targets_file_path <full path to the targets.csv file generated by the run-scan.sh script, e.g., $SCRIPT_DIR/../data/generated/scan/data/BOR/630-dafny_tmp_tmpz2kokaiq_Solution/targets.csv> \
  --helpers_file_path <full path to the helpers.txt file generated by the run-scan.sh script, e.g., $SCRIPT_DIR/../data/generated/scan/data/BOR/630-dafny_tmp_tmpz2kokaiq_Solution/helpers.txt> \
  --output_file_path <full path to the file where runtime data will be written, e.g., $SCRIPT_DIR/../data/generated/mut/data/<mutation operator>/<Dafny program name>/data.csv> \
  --output_directory_path <full path to the directory where mutants will be saved, e.g., $SCRIPT_DIR/../data/generated/mut/mutants/<mutation operator>/<Dafny program name>/> \
  [help]"
if [ "$#" -ne "1" ] && [ "$#" -ne "10" ]; then
  die "$USAGE"
fi

# Print out script's arguments (which could help any debug session)
echo "[INFO] ${BASH_SOURCE[0]} $@"

INPUT_FILE_PATH=""
TARGETS_FILE_PATH=""
HELPERS_FILE_PATH=""
OUTPUT_FILE_PATH=""
OUTPUT_DIRECTORY_PATH=""

while [[ "$1" = --* ]]; do
  OPTION=$1; shift
  case $OPTION in
    (--input_file_path)
      INPUT_FILE_PATH=$1;
      shift;;
    (--targets_file_path)
      TARGETS_FILE_PATH=$1;
      shift;;
    (--helpers_file_path)
      HELPERS_FILE_PATH=$1;
      shift;;
    (--output_file_path)
      OUTPUT_FILE_PATH=$1;
      shift;;
    (--output_directory_path)
      OUTPUT_DIRECTORY_PATH=$1;
      shift;;
    (--help)
      echo "$USAGE";
      exit 0;;
    (*)
      die "$USAGE";;
  esac
done

# Check whether all arguments have been initialized
[ "$INPUT_FILE_PATH" != "" ]       || die "[ERROR] Missing --input_file_path argument!"
[ "$TARGETS_FILE_PATH" != "" ]     || die "[ERROR] Missing --targets_file_path argument!"
[ "$HELPERS_FILE_PATH" != "" ]     || die "[ERROR] Missing --helpers_file_path argument!"
[ "$OUTPUT_FILE_PATH" != "" ]      || die "[ERROR] Missing --output_file_path argument!"
[ "$OUTPUT_DIRECTORY_PATH" != "" ] || die "[ERROR] Missing --output_directory_path argument!"

# Check whether some arguments have been correctly initialized
[ -s "$INPUT_FILE_PATH" ]   || die "[ERROR] $INPUT_FILE_PATH does not exist or it is empty!"
[ -s "$TARGETS_FILE_PATH" ] || die "[ERROR] $TARGETS_FILE_PATH does not exist or it is empty!"
[ -s "$HELPERS_FILE_PATH" ] || die "[ERROR] $HELPERS_FILE_PATH does not exist or it is empty!"

# ------------------------------------------------------------------------- Main

echo "[INFO] Job started at $(date)"
echo "[INFO] PID: $$"
echo "[INFO] $(hostname)"
echo "[INFO] Running MutDafny's run command on $INPUT_FILE_PATH"

# Create output directory, if it does not exist
mkdir -p "$OUTPUT_DIRECTORY_PATH" || die "[ERROR] Failed to create $OUTPUT_DIRECTORY_PATH!"

# Clean up output directory
rm -rf "$OUTPUT_DIRECTORY_PATH"/* "$OUTPUT_DIRECTORY_PATH"/.* > /dev/null 2>&1

# Copy the helpers.txt file generated by the run-scan.sh script
cp "$HELPERS_FILE_PATH" "$OUTPUT_DIRECTORY_PATH/helpers.txt"

# Create data file
echo "program_name,mutation_position,mutation_operator,mutation,status,parsing_time,plugin_time,resolution_time,verification_time,run_time" > "$OUTPUT_FILE_PATH" || die "[ERROR] Failed to create $OUTPUT_FILE_PATH!"

tmp_log_file="$OUTPUT_DIRECTORY_PATH/.tmp_mut.log"
rm -f "$tmp_log_file"

pushd . > /dev/null 2>&1
cd "$OUTPUT_DIRECTORY_PATH"

  while read -r row; do # 335,BOR,Ge
    pos=$(echo "$row" | cut -f1 -d',')
    ope=$(echo "$row" | cut -f2 -d',')
    arg=$(echo "$row" | cut -f3 -d',') # Some mutation operators do not have a third element

    start=$(date +%s%3N)
    "$DOTNET_HOME_DIR/dotnet" "$MUTDAFNY_HOME_DIR/dafny/Binaries/Dafny.dll" verify "$INPUT_FILE_PATH" \
        --allow-warnings --solver-path "$MUTDAFNY_HOME_DIR/dafny/Binaries/z3" \
        --plugin "$MUTDAFNY_HOME_DIR/mutdafny/bin/Debug/net8.0/mutdafny.dll","mut $pos $ope $arg" > "$tmp_log_file" 2>&1
    if [ "$?" -ne "0" ]; then
      cat "$tmp_log_file"
      echo "[ERROR] Failed to run MutDafny's run command on $row!"
      continue
    else
      cat "$tmp_log_file"
    fi
    end=$(date +%s%3N)

    # Check mutant's status
    if grep -q "Dafny program verifier finished.*0 errors" "$tmp_log_file"; then
      echo "[DEBUG] Verification succeeded, i.e., mutant survived"
      status="alive"
    elif grep -q "Dafny program verifier finished.*time out" "$tmp_log_file"; then
      echo "[DEBUG] Verification timed out"
      status="timeout"
    else
      echo "[DEBUG] Verification failed, i.e., mutant was killed"
      status="killed"
    fi

    elapsed_time_file="elapsed-time.csv" # parsing_time,plugin_time,resolution_time,verification_time
    [ -s "$elapsed_time_file" ] || die "[ERROR] $elapsed_time_file does not exist or it is empty!"
    echo "[DEBUG] $elapsed_time_file:"
    cat "$elapsed_time_file"

    # Save runtime data
    echo "$(basename $INPUT_FILE_PATH .dfy),$row,$status,$(tail -n1 $elapsed_time_file),$(echo $end - $start | bc)" >> "$data_file" || die "[ERROR] Failed to populate $OUTPUT_FILE_PATH!"
  done < <(cat "$TARGETS_FILE_PATH")

popd > /dev/null 2>&1

# Remove temporary files
rm -f "$OUTPUT_DIRECTORY_PATH/helpers.txt" "$tmp_log_file"

echo "[INFO] Job finished at $(date)"
echo "DONE!"
exit 0

# EOF
